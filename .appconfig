#!/bin/bash

# allow mtr to run without sudo
mtrlocation=$(brew info mtr | grep Cellar | sed -e 's/ (.*//') #  e.g. `/Users/paulirish/.homebrew/Cellar/mtr/0.86`
sudo chmod 4755 $mtrlocation/sbin/mtr
sudo chown root $mtrlocation/sbin/mtr

# Configure Blackfire
sudo blackfire-agent -register
ln -sfv /usr/local/opt/blackfire-agent/*.plist ~/Library/LaunchAgents

## Configure MySQL
mysql_secure_installation
sudo mkdir /var/mysql
sudo ln -s /tmp/mysql.sock /var/mysql/mysql.sock

# Update global git config
git lfs install
# Update system git config
sudo git lfs install --system

# Configure PHP
cp ./Apache/zz_personal.ini /usr/local/etc/php/5.5/conf.d/zz_personal.ini
cp ./Apache/zz_personal.ini /usr/local/etc/php/5.6/conf.d/zz_personal.ini
cp ./Apache/zz_personal.ini /usr/local/etc/php/7.0/conf.d/zz_personal.ini
cp ./Apache/zz_personal.ini /usr/local/etc/php/7.1/conf.d/zz_personal.ini

# Configure Apache

COMM='s/username/'$(whoami)'/g'
for i in /etc/apache2/other/*.conf  
  do
    sudo sed -i -e $COMM "$i" 
done

apacheConf=`httpd -V | grep -i server_config_file | cut -d '"' -f 2`

PATTERN="# Brew PHP LoadModule for 'sphp' switcher"

if grep -q "$PATTERN" $apacheConf;
 then
    echo "sphp is already set"
 else
    sudo sed -i -e '/libphp5.so/d' $apacheConf
    echo "# Brew PHP LoadModule for 'sphp' switcher" >> $apacheConf
    echo "#LoadModule php5_module /usr/local/lib/libphp5.so" >> $apacheConf
    echo "LoadModule php7_module /usr/local/lib/libphp7.so" >> $apacheConf
fi

PATTERN="Include /private/etc/apache2/other/*.conf"

if grep -q $PATTERN $apacheConf;
 then
    echo "other conf is already set"
 else
    sudo echo "" >> $apacheConf
    sudo echo "$PATTERN" >> $apacheConf
fi

PATTERN="DirectoryIndex index.html"

if grep -q "$PATTERN" $apacheConf;
 then
    sudo echo "" >> $apacheConf
    sudo sudo sudo sed -i -e "s/$PATTERN/DirectoryIndex index.php index.html/g" $apacheConf
 else
    echo "DirectoryIndex is already set"
fi

sudo sed -i -e "/LoadModule rewrite_module/s/^#*//" $apacheConf
sudo perl -i -0pe "s/    AllowOverride none\n    Require all denied\n/    Options FollowSymLinks Multiviews Indexes\n    AllowOverride All\n    Require all granted\n/" $apacheConf
sudo echo "" >> $apacheConf
sudo echo "Options FollowSymLinks Multiviews Indexes" >> $apacheConf

sudo perl -i -0pe "s/    AllowOverride none\n    Require all denied\n/    Options FollowSymLinks Multiviews Indexes\n    AllowOverride All\n    Require all granted\n/" $apacheConf
sudo sudo sed -i -e 's/User _www/User '$(whoami)'/g' $apacheConf
sudo sudo sed -i -e 's/Group _www/Group staff/g' $apacheConf

PATTERN="SetHandler application/x-httpd-php"
if grep -q "${PATTERN}" $apacheConf;
 then
    echo "PHP is already set"
 else
    sudo echo "" >> $apacheConf
    sudo echo "<FilesMatch \.php$>" >> $apacheConf
    sudo echo '    '${PATTERN} >> $apacheConf
    sudo echo "</FilesMatch>" >> $apacheConf
fi