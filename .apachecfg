# Configure PHP
sudo chmod -R guo+rw  /usr/local/etc/php/5.6/conf.d
sudo chmod -R guo+rw  /usr/local/etc/php/7.0/conf.d
sudo chmod -R guo+rw  /usr/local/etc/php/7.1/conf.d
sudo chmod -R guo+rw  /usr/local/etc/php/7.2/conf.d
cp ./Apache/zz_personal.ini /usr/local/etc/php/5.6/conf.d/zz_personal.ini
cp ./Apache/zz_personal.ini /usr/local/etc/php/7.0/conf.d/zz_personal.ini
cp ./Apache/zz_personal.ini /usr/local/etc/php/7.1/conf.d/zz_personal.ini
cp ./Apache/zz_personal.ini /usr/local/etc/php/7.2/conf.d/zz_personal.ini

# Configure Apache

apacheConf=`httpd -V | grep -i server_config_file | cut -d '"' -f 2`
apacheRoot=${apacheConf::${#apacheConf}-10}

sudo chmod -R guo+rw ${apacheRoot}extra
if ! [ -d "${apacheRoot}/other" ]
then
    mkdir -p ${apacheRoot}other
fi;
sudo chmod -R guo+rw ${apacheRoot}other
sudo chmod -R guo+rw $apacheConf

COMM='s/username/'$(whoami)'/g'
for i in ${apacheRoot}other/*.conf  
  do
    sudo sed -i -e $COMM "$i" 
done

PATTERN="# Brew PHP LoadModule for 'sphp' switcher"

if grep -q "$PATTERN" $apacheConf;
 then
    echo "sphp is already set"
 else
    sudo sed -i -e '/libphp5.so/d' $apacheConf
    sudo echo "# Brew PHP LoadModule for 'sphp' switcher" >> $apacheConf
    sudo echo "#LoadModule php5_module /usr/local/lib/libphp5.so" >> $apacheConf
    sudo echo "LoadModule php7_module /usr/local/lib/libphp7.so" >> $apacheConf
fi

PATTERN="Include /private/etc/apache2/other/*.conf"

if grep -q $PATTERN $apacheConf;
 then
    echo "other conf is already set"
 else
    sudo echo "" >> $apacheConf
    sudo echo "$PATTERN" >> $apacheConf
fi

PATTERN="DirectoryIndex index.html"

if grep -q "$PATTERN" $apacheConf;
 then
    sudo echo "" >> $apacheConf
    sudo sed -i -e "s/$PATTERN/DirectoryIndex index.php index.html/g" $apacheConf
 else
    echo "DirectoryIndex is already set"
fi

sudo sed -i -e "/LoadModule rewrite_module/s/^#*//" $apacheConf
sudo perl -i -0pe "s/    AllowOverride none\n    Require all denied\n/    Options FollowSymLinks Multiviews Indexes\n    AllowOverride All\n    Require all granted\n/" $apacheConf
sudo echo "" >> $apacheConf
sudo echo "Options FollowSymLinks Multiviews Indexes" >> $apacheConf

sudo perl -i -0pe "s/    AllowOverride none\n    Require all denied\n/    Options FollowSymLinks Multiviews Indexes\n    AllowOverride All\n    Require all granted\n/" $apacheConf
sudo sed -i -e 's/User _www/User '$(whoami)'/g' $apacheConf
sudo sed -i -e 's/Group _www/Group staff/g' $apacheConf

PATTERN="SetHandler application/x-httpd-php"
if grep -q "${PATTERN}" $apacheConf;
 then
    echo "PHP is already set"
 else
    sudo echo "" >> $apacheConf
    sudo echo "<FilesMatch \.php$>" >> $apacheConf
    sudo echo '    '${PATTERN} >> $apacheConf
    sudo echo "</FilesMatch>" >> $apacheConf
fi

apachePlist=`httpd -V | grep -i HTTPD_ROOT | cut -d '"' -f 2`
sudo cp -v ${apachePlist}/homebrew.mxcl.httpd24.plist /Library/LaunchDaemons
sudo chown -v root:wheel /Library/LaunchDaemons/homebrew.mxcl.httpd24.plist
sudo chmod -v 644 /Library/LaunchDaemons/homebrew.mxcl.httpd24.plist
sudo launchctl load /Library/LaunchDaemons/homebrew.mxcl.httpd24.plist

sudo ln -sf /usr/local/opt/php71/libexec/apache2/libphp7.so /usr/local/lib/libphp7.so
apachectl -k restart